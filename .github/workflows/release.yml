name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          release_name: BOOTH File Organizer v${{ steps.get_version.outputs.version }}
          body: |
            # BOOTH File Organizer v${{ steps.get_version.outputs.version }}

            ## ðŸŽ‰ æ–°æ©Ÿèƒ½
            - BOOTH JSON APIå¯¾å¿œã«ã‚ˆã‚‹é«˜é€Ÿã‚¿ã‚°æŠ½å‡º
            - ãƒ¢ã‚¸ãƒ¥ãƒ©ãƒ¼ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ã‚ˆã‚‹ä¿å®ˆæ€§å‘ä¸Š
            - ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã§å¤§é‡ãƒ‡ãƒ¼ã‚¿å¯¾å¿œ
            - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–ã«ã‚ˆã‚‹é«˜é€ŸåŒ–
            
            ## ðŸ“¦ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            
            ### Windows
            - **ãƒãƒ¼ã‚¿ãƒ–ãƒ«ç‰ˆ** (æŽ¨å¥¨): `BOOTH_File_Organizer_Windows_Portable.zip`
              - ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸è¦ã€è§£å‡ã—ã¦å³ä½¿ç”¨å¯èƒ½
            - **ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ç‰ˆ**: `BOOTH_File_Organizer_Setup.exe`
              - å¾“æ¥ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹å¼
            
            ## ðŸ“ æ›´æ–°å†…å®¹
            
            è©³ç´°ãªå¤‰æ›´å†…å®¹ã¯[CHANGELOG](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)ã‚’ã”è¦§ãã ã•ã„ã€‚
            
            ## ðŸ› æ—¢çŸ¥ã®å•é¡Œ
            
            å•é¡Œã‚’ç™ºè¦‹ã—ãŸå ´åˆã¯[Issues](https://github.com/${{ github.repository }}/issues)ã§ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚
          draft: false
          prerelease: false

  build-windows:
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-gnu

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64 gcc-mingw-w64-x86-64 nsis

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: src-tauri/target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Install npm dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Build Windows executable
        run: |
          npx tauri build --target x86_64-pc-windows-gnu || true
          # Even if installer fails, executable should be built

      - name: Create portable package
        working-directory: src-tauri/target/x86_64-pc-windows-gnu/release
        run: |
          mkdir -p BOOTH_File_Organizer_Windows_Portable
          cp booth-organizer.exe BOOTH_File_Organizer_Windows_Portable/
          cp *.dll BOOTH_File_Organizer_Windows_Portable/ || true
          
          # Create README
          cat > BOOTH_File_Organizer_Windows_Portable/README.txt << EOF
          BOOTH File Organizer - Windows Portable Edition
          ===============================================
          
          Version: ${{ needs.create-release.outputs.version }}
          Build Date: $(date +%Y-%m-%d)
          
          ã€ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã€‘
          1. ã“ã®ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»»æ„ã®å ´æ‰€ã«ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„
          2. booth-organizer.exe ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ã¦å®Ÿè¡Œã—ã¾ã™
          
          ã€å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã€‘
          - booth-organizer.exe (ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«)
          - booth_organizer_lib.dll (ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ©ã‚¤ãƒ–ãƒ©ãƒª)
          - WebView2Loader.dll (Webãƒ“ãƒ¥ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ)
          
          ã€å‹•ä½œè¦ä»¶ã€‘
          - Windows 10/11 x64
          - Microsoft Edge WebView2 Runtime
          
          ãŠå•ã„åˆã‚ã›: https://github.com/${{ github.repository }}/issues
          EOF
          
          # Create ZIP
          zip -r ../../../BOOTH_File_Organizer_Windows_Portable.zip BOOTH_File_Organizer_Windows_Portable/

      - name: Upload Windows Portable to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: src-tauri/target/x86_64-pc-windows-gnu/BOOTH_File_Organizer_Windows_Portable.zip
          asset_name: BOOTH_File_Organizer_v${{ needs.create-release.outputs.version }}_Windows_Portable.zip
          asset_content_type: application/zip

      - name: Upload Windows Installer to Release (if exists)
        continue-on-error: true
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: src-tauri/target/x86_64-pc-windows-gnu/release/bundle/nsis/BOOTH File Organizer_${{ needs.create-release.outputs.version }}_x64-setup.exe
          asset_name: BOOTH_File_Organizer_v${{ needs.create-release.outputs.version }}_Setup.exe
          asset_content_type: application/octet-stream

  update-changelog:
    needs: build-windows
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update release notes
        run: |
          echo "# Release v${{ needs.create-release.outputs.version }} completed" >> RELEASE_NOTES.md
          echo "Date: $(date +%Y-%m-%d)" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "All artifacts have been successfully built and uploaded." >> RELEASE_NOTES.md